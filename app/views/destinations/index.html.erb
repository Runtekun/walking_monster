<!-- èƒŒæ™¯å…¨ä½“ -->
<div class="w-full min-h-screen relative"
     style="background-image: url(<%= asset_path('destinations-bg.jpg') %>);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;">

  <!-- èƒŒæ™¯ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div class="absolute inset-0 z-0"></div>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
  <div class="relative z-10 flex justify-center items-start pt-10 pb-16 min-h-screen">
    <div class="w-full max-w-3xl bg-white bg-opacity-90 rounded-xl shadow-xl px-6 py-10 font-[PixelMplus10]">

      <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
      <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-[#3a1e00]">ğŸ—ºï¸ è¡Œãå…ˆã‚’æ±ºã‚ã‚ˆã†ï¼</h1>
        <p class="text-sm text-[#5f4b32] mt-1">ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã¨ä¸€ç·’ã«å†’é™ºã®æ—…ã«å‡ºã‹ã‘ã‚ˆã†ï¼</p>
      </div>

      <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ‘ãƒãƒ« -->
      <div class="flex items-center justify-between bg-[#fff4d1] border-2 border-yellow-300 rounded-lg p-4 shadow-md mb-6">
        <!-- å·¦å´ï¼šç”»åƒã¨ãƒ¬ãƒ™ãƒ« -->
        <div class="flex items-center gap-4">
          <!-- ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ç”»åƒï¼ˆé€²åŒ–æ®µéšã«å¿œã˜ã¦ï¼‰ -->
          <% 
            if @user_monster.level >= @species.evolution_level_2
              image_to_display = @species.image_3
            elsif @user_monster.level >= @species.evolution_level_1
              image_to_display = @species.image_2
            else
              image_to_display = @species.image_1
            end
          %>
          <% if image_to_display.present? %>
            <%= image_tag image_to_display.url, class: "w-14 h-14 object-contain" %>
          <% else %>
            <%= image_tag "/fallback_monster.png", class: "w-14 h-14 object-contain" %>
          <% end %>

          <div>
            <p class="text-lg font-bold text-[#4b3300]">Lv<%= @user_monster.level %></p>
            <div class="w-40 bg-yellow-200 h-3 rounded-full overflow-hidden">
              <% percent = ((@user_monster.experience.to_f / @user_monster.next_level_experience) * 100).floor rescue 0 %>
              <div class="bg-green-500 h-full" style="width: <%= percent %>%"></div>
            </div>
            <p class="text-xs text-gray-700 mt-1">
              <%= @user_monster.experience %> / <%= @user_monster.next_level_experience %> XP
            </p>
          </div>
        </div>

        <!-- å³å´ï¼šå†’é™ºå±¥æ­´ -->
        <div class="text-right text-sm text-gray-600">
          <p>å†’é™ºå±¥æ­´ï¼š<strong><%= current_user.total_adventure_count %>å›</strong></p>
        </div>
      </div>

      <!-- åœ°å›³ä¸­å¿ƒåœ°è¨­å®š -->
      <div class="bg-white border border-yellow-300 p-4 rounded-xl shadow mb-6 space-y-2">
        <label for="address" class="text-sm font-bold text-[#3e2c00]">ğŸ° åœ°å›³ã®ä¸­å¿ƒã‚’è¨­å®šï¼ˆä¾‹ï¼šæ±äº¬é§…ï¼‰</label>
        <div class="flex gap-2">
          <input id="address" type="text" placeholder="ä¾‹ï¼šæ±äº¬é§…"
                 class="flex-1 px-4 py-2 border rounded-lg border-yellow-400 focus:outline-none focus:ring-2 focus:ring-yellow-300 bg-yellow-50" />
          <button onclick="codeAddress()"
                  class="px-4 py-2 bg-yellow-400 hover:bg-yellow-500 text-white font-bold rounded-lg shadow">
            æ¤œç´¢
          </button>
        </div>
      </div>

      <!-- è·é›¢åˆ¶é™ãƒãƒŠãƒ¼ -->
      <div class="bg-yellow-100 border border-yellow-300 text-yellow-800 rounded-lg px-4 py-3 mb-6 text-sm flex items-center shadow-sm">
        <svg class="w-5 h-5 mr-2 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M8.257 3.099c.366-.446.994-.553 1.44-.187l.094.083 6 6c.38.38.44.97.143 1.414l-.083.094-6 6c-.446.366-1.074.259-1.44-.187l-.083-.094-6-6a1 1 0 01-.083-1.32l.083-.094 6-6z" clip-rule="evenodd" />
        </svg>
        å†’é™ºã®è¨˜éŒ²ã¯<strong class="mx-1">æœ€å¤§15km</strong>ã¾ã§ä¿å­˜ã§ãã¾ã™ã€‚ãã‚Œä»¥ä¸Šã®è·é›¢ã¯ç™»éŒ²ã•ã‚Œã¾ã›ã‚“ã€‚
      </div>

      <!-- å‡ºç™ºåœ°ãƒ»ç›®çš„åœ° -->
      <div class="grid sm:grid-cols-2 gap-4 bg-white p-4 border border-yellow-300 rounded-xl shadow mb-6">
        <div>
          <label for="start" class="block text-sm font-bold text-[#3e2c00]">ğŸš¶ å‡ºç™ºåœ°</label>
          <input id="start" type="text" placeholder="ä¾‹ï¼šè‡ªå®…ãƒ»é§…"
                 class="w-full px-4 py-2 border rounded-lg border-yellow-400 bg-yellow-50 focus:outline-none focus:ring-2 focus:ring-yellow-300" />
        </div>
        <div>
          <label for="end" class="block text-sm font-bold text-[#3e2c00]">ğŸ¯ ç›®çš„åœ°</label>
          <input id="end" type="text" placeholder="ä¾‹ï¼šã€‡ã€‡å…¬åœ’ãƒ»ã‚«ãƒ•ã‚§"
                 class="w-full px-4 py-2 border rounded-lg border-yellow-400 bg-yellow-50 focus:outline-none focus:ring-2 focus:ring-yellow-300" />
        </div>
      </div>

      <!-- çµŒè·¯è¡¨ç¤º -->
      <div class="mb-6">
        <button onclick="getRoute()"
                class="w-full py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg shadow-xl text-lg transition">
          ğŸŒŸ è¡Œãå…ˆã‚’æ±ºå®šã™ã‚‹
        </button>
      </div>

      <!-- ãƒãƒƒãƒ— -->
      <div class="rounded-lg overflow-hidden border-2 border-yellow-300 shadow-xl mb-4">
        <div id="map" class="w-full h-[400px] bg-gray-200"></div>
      </div>

      <!-- çµŒè·¯æƒ…å ± -->
      <div id="route-info" class="text-center font-bold text-[#3e2c00] mb-4 text-base"></div>

      <!-- ä¿å­˜ãƒ•ã‚©ãƒ¼ãƒ  -->
      <%= form_with url: destinations_path, method: :post do %>
        <%= hidden_field_tag 'destination[start]', nil, id: 'hidden_start' %>
        <%= hidden_field_tag 'destination[end]', nil, id: 'hidden_end' %>
        <%= hidden_field_tag 'destination[distance]', nil, id: 'hidden_distance' %>
        <%= hidden_field_tag 'destination[duration]', nil, id: 'hidden_duration' %>
        <%= hidden_field_tag 'destination[steps]', nil, id: 'hidden_steps' %>

        <%= submit_tag 'âœ… ã“ã®å†’é™ºã‚’è¨˜éŒ²ã™ã‚‹ ', class: "w-full py-3 bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-lg shadow transition mb-10" %>
      <% end %>

      <!-- è¡Œãå…ˆãƒªã‚¹ãƒˆ -->
      <div class="bg-white border border-yellow-300 rounded-xl shadow p-4">
        <h2 class="text-xl font-bold text-[#3e2c00] mb-4">ğŸ“œ ã‚ãªãŸã®å†’é™ºãƒªã‚¹ãƒˆ</h2>
        <% if @destinations.any? %>
          <% @destinations.each do |d| %>
            <% next if d.id.nil? %>
            <div class="flex justify-between items-center bg-yellow-50 p-3 rounded-lg mb-2">
              <div class="flex-1 min-w-0">
                <p class="font-semibold text-[#3e2c00] truncate"><%= d.start %> â†’ <%= d.end %></p>
                <p class="text-sm text-gray-600"><%= d.distance %></p>
              </div>
              <div class="ml-4 shrink-0">
                <%= link_to "è©³ç´°", destination_path(d), class: "text-blue-600 hover:underline text-sm whitespace-nowrap" %>
              </div>
            </div>
          <% end %>
        <% else %>
          <p class="text-gray-500 text-sm">ã¾ã å†’é™ºã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        <% end %>
      </div>

    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°å®šç¾©
  if (typeof geocoder === "undefined") var geocoder;
  if (typeof map === "undefined") var map;
  if (typeof marker === "undefined") var marker;
  if (typeof infoWindow === "undefined") var infoWindow;
  if (typeof directionsService === "undefined") var directionsService;
  if (typeof directionsRenderer === "undefined") var directionsRenderer;

  // åˆæœŸåŒ–
  function initMap() {
    const mapElement = document.getElementById('map');
    if (!mapElement) return;

    const mapOptions = {
      center: { lat: 35.6803997, lng: 139.7690174 },
      zoom: 10
    };

    geocoder = new google.maps.Geocoder();
    map = new google.maps.Map(mapElement, mapOptions);

    marker = new google.maps.Marker({
      position: mapOptions.center,
      map: map,
      draggable: true
    });

    infoWindow = new google.maps.InfoWindow();
    infoWindow.setContent("æ±äº¬é§…");
    infoWindow.open(map, marker);

    marker.addListener('dragend', function () {
      const pos = marker.getPosition();
      geocoder.geocode({ location: pos }, function (results, status) {
        if (status === 'OK' && results[0]) {
          infoWindow.setContent(results[0].formatted_address);
          infoWindow.open(map, marker);
        } else {
          infoWindow.setContent('ä½æ‰€ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
          infoWindow.open(map, marker);
        }
      });
    });

    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({ map: map });
  }

  // Turboå¯¾å¿œï¼šã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰ã«ãƒãƒƒãƒ—ç ´æ£„
  document.addEventListener("turbo:before-cache", () => {
    if (marker) marker.setMap(null);
    if (directionsRenderer) directionsRenderer.setMap(null);
  });

  // Turboå¯¾å¿œï¼šãƒ­ãƒ¼ãƒ‰æ™‚ãƒãƒƒãƒ—åˆæœŸåŒ–
  document.addEventListener("turbo:load", () => {
    if (typeof google !== 'undefined' && google.maps) {
      initMap();
    }
  });

  // ä½æ‰€æ¤œç´¢â†’ãƒãƒƒãƒ—è¡¨ç¤º
  function codeAddress() {
    let inputAddress = document.getElementById('address').value;

    geocoder.geocode({ address: inputAddress }, function (results, status) {
      if (status === 'OK') {
        const location = results[0].geometry.location;

        // æ—¢å­˜ãƒãƒ¼ã‚«ãƒ¼å‰Šé™¤
        if (marker) marker.setMap(null);

        // æ–°ã—ã„ãƒãƒ¼ã‚«ãƒ¼è¨­ç½®ï¼ˆãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ï¼‰
        marker = new google.maps.Marker({
          map: map,
          position: location,
          draggable: true
        });

        // åœ°å›³ä¸­å¿ƒã‚’ä½æ‰€ã¸
        map.setCenter(location);

        // å¹ãå‡ºã—è¨­å®š
        infoWindow.setContent(results[0].formatted_address);
        infoWindow.open(map, marker);

        // ãƒãƒ¼ã‚«ãƒ¼ç§»å‹•æ™‚ã«ä½æ‰€ã‚’å†å–å¾—
        marker.addListener('dragend', function () {
          const newPos = marker.getPosition();
          geocoder.geocode({ location: newPos }, function (results, status) {
            if (status === 'OK' && results[0]) {
              infoWindow.setContent(results[0].formatted_address);
              infoWindow.open(map, marker);
            } else {
              infoWindow.setContent('ä½æ‰€ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
              infoWindow.open(map, marker);
            }
          });
        });

      } else {
        alert('è©²å½“ã™ã‚‹çµæœãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼š' + status);
      }
    });
  }

  // çµŒè·¯æ¤œç´¢ã¨è¡¨ç¤º
  function getRoute() {
    const start = document.getElementById("start").value;
    const end = document.getElementById("end").value;

    const request = {
      origin: start,
      destination: end,
      travelMode: google.maps.TravelMode.WALKING
    };

    directionsService.route(request, function (result, status) {
      if (status === "OK") {
        directionsRenderer.setDirections(result);

        const leg = result.routes[0].legs[0];
        const distance = leg.distance.text;
        const duration = leg.duration.text;
        const distanceMeters = leg.distance.value;
        const steps = Math.round(distanceMeters / 0.7);

        document.getElementById("route-info").innerHTML =
          `è·é›¢: ${distance}ãƒ»æ‰€è¦æ™‚é–“: ${duration}ãƒ»æ¨å®šæ­©æ•°: ${steps.toLocaleString()} æ­©`;

        // hiddenå€¤ã«ä»£å…¥
        document.getElementById("hidden_start").value = start;
        document.getElementById("hidden_end").value = end;
        document.getElementById("hidden_distance").value = distance;
        document.getElementById("hidden_duration").value = duration;
        document.getElementById("hidden_steps").value = steps;
      } else {
        alert("ãƒ«ãƒ¼ãƒˆæ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ: " + status);
      }
    });
  }
</script>

<!-- Google Maps èª­ã¿è¾¼ã¿ -->
<% content_for :google_maps do %>
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_MAPS_API_KEY'] %>&callback=initMap">
  </script>
<% end %>