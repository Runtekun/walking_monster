<!-- èƒŒæ™¯å…¨ä½“ -->
<div class="w-full relative"
     style="background-image: url(<%= asset_path('destinations-bg.jpg') %>);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;">

  <!-- èƒŒæ™¯ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div class="absolute inset-0 z-0"></div>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
  <div class="relative z-10 flex justify-center items-start pt-10 pb-24"> 

    <div class="w-full max-w-3xl bg-white bg-opacity-90 rounded-xl shadow-xl px-6 py-10 font-[PixelMplus10]">

      <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
      <div class="text-center mb-8">
        <h1 class="text-2xl font-bold text-[#3a1e00]">ğŸ› ï¸ è¡Œãå…ˆã‚’ç·¨é›†ã—ã‚ˆã†ï¼</h1>
        <p class="text-sm text-[#5f4b32] mt-1">å‡ºç™ºåœ°ã¨ç›®çš„åœ°ã‚’ä¿®æ­£ã—ã€å†åº¦ãƒ«ãƒ¼ãƒˆã‚’ç¢ºèªã§ãã¾ã™ã€‚</p>
      </div>

      <!-- ä½æ‰€ã‹ã‚‰åœ°å›³ä¸­å¿ƒã‚’æ¤œç´¢ -->
      <div class="space-y-2 mb-6">
        <label for="address" class="block text-sm font-bold text-[#3e2c00]">ğŸ” åœ°å›³ã®ä¸­å¿ƒã‚’ä½æ‰€ã‹ã‚‰æ¤œç´¢</label>
        <div class="flex gap-2">
          <input id="address" type="text" value="<%= @destination.start %>" 
              placeholder="ä¾‹ï¼šæ±äº¬é§…"
              class="flex-1 px-4 py-2 border rounded-lg border-yellow-400 focus:outline-none focus:ring-2 focus:ring-yellow-300 bg-yellow-50" />
          <input type="button" value="æ¤œç´¢" onclick="codeAddress()" 
              class="px-4 py-2 bg-yellow-400 hover:bg-yellow-500 text-white font-bold rounded-lg shadow" />
        </div>
      </div>

      <!-- å‡ºç™ºåœ°ãƒ»ç›®çš„åœ° -->
      <div class="grid sm:grid-cols-2 gap-4 mb-6">
        <div>
          <label for="start" class="block text-sm font-bold text-[#3e2c00]">ğŸš¶ å‡ºç™ºåœ°</label>
          <input id="start" type="text" value="<%= @destination.start %>" placeholder="å‡ºç™ºåœ°ã‚’å…¥åŠ›"
            class="w-full px-4 py-2 border rounded-lg border-yellow-400 bg-yellow-50 focus:outline-none focus:ring-2 focus:ring-yellow-300" />
        </div>
        <div>
          <label for="end" class="block text-sm font-bold text-[#3e2c00]">ğŸ¯ ç›®çš„åœ°</label>
          <input id="end" type="text" value="<%= @destination.end %>" placeholder="ç›®çš„åœ°ã‚’å…¥åŠ›"
            class="w-full px-4 py-2 border rounded-lg border-yellow-400 bg-yellow-50 focus:outline-none focus:ring-2 focus:ring-yellow-300" />
        </div>
      </div>

      <!-- çµŒè·¯è¡¨ç¤º -->
      <button onclick="getRoute()"
        class="w-full py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg shadow-xl text-lg transition mb-6">
        ğŸŒŸ çµŒè·¯ã‚’è¡¨ç¤º
      </button>

      <!-- åœ°å›³ -->
      <div class="rounded-lg overflow-hidden border-2 border-yellow-300 shadow-xl mb-4">
        <div id="map" class="w-full h-[400px] bg-gray-200"></div>
      </div>

      <!-- çµŒè·¯æƒ…å ± -->
      <div id="route-info" class="text-center font-bold text-[#3e2c00] mb-4 text-base">
        è·é›¢: <%= @destination.distance %>ãƒ»æ‰€è¦æ™‚é–“: <%= @destination.duration %>ãƒ»æ¨å®šæ­©æ•°: <%= number_with_delimiter(@destination.steps) %> æ­©
      </div>

      <!-- ä¿å­˜ãƒ•ã‚©ãƒ¼ãƒ  -->
      <%= form_with(model: @destination, method: :patch) do |f| %>
        <%= hidden_field_tag 'destination[start]', @destination.start, id: 'hidden_start' %>
        <%= hidden_field_tag 'destination[end]', @destination.end, id: 'hidden_end' %>
        <%= hidden_field_tag 'destination[distance]', @destination.distance, id: 'hidden_distance' %>
        <%= hidden_field_tag 'destination[duration]', @destination.duration, id: 'hidden_duration' %>
        <%= hidden_field_tag 'destination[steps]', @destination.steps, id: 'hidden_steps' %>

        <%= f.submit 'âœ… æ›´æ–°ã™ã‚‹ï¼ˆå†’é™ºè¨˜éŒ²ï¼‰', class: "w-full py-3 bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-lg shadow transition" %>
      <% end %>
    </div>
  </div>
</div>

<script>
  if (typeof geocoder === "undefined") var geocoder;
  if (typeof map === "undefined") var map;
  if (typeof marker === "undefined") var marker;
  if (typeof directionsService === "undefined") var directionsService;
  if (typeof directionsRenderer === "undefined") var directionsRenderer;

  function initMap() {
    const mapElement = document.getElementById('map');
    if (!mapElement) return;

    const mapOptions = {
      center: { lat: 35.6803997, lng: 139.7690174 },
      zoom: 10
    };

    geocoder = new google.maps.Geocoder();
    map = new google.maps.Map(mapElement, mapOptions);

    marker = new google.maps.Marker({
      position: { lat: 35.6803997, lng: 139.7690174 },
      map: map
    });

    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({ map: map });
  }

  document.addEventListener("turbo:before-cache", () => {
    if (marker) marker.setMap(null);
    if (directionsRenderer) directionsRenderer.setMap(null);
  });

  document.addEventListener("turbo:load", () => {
    if (typeof google !== 'undefined' && google.maps) initMap();
  });

  function codeAddress() {
    let inputAddress = document.getElementById('address').value;
    geocoder.geocode({ 'address': inputAddress }, function(results, status) {
      if (status === 'OK') {
        if (marker) marker.setMap(null);
        map.setCenter(results[0].geometry.location);
        marker = new google.maps.Marker({ map: map, position: results[0].geometry.location });
      } else {
        alert('è©²å½“ã™ã‚‹çµæœãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼š' + status);
      }
    });
  }

  function getRoute() {
    const start = document.getElementById("start").value;
    const end = document.getElementById("end").value;

    const request = {
      origin: start,
      destination: end,
      travelMode: google.maps.TravelMode.WALKING
    };

    directionsService.route(request, function(result, status) {
      if (status === "OK") {
        directionsRenderer.setDirections(result);
        // ãƒ«ãƒ¼ãƒˆæƒ…å ±ã‚’ç”»é¢ã«è¡¨ç¤ºã™ã‚‹å‡¦ç†ã‚’è¿½åŠ å¯èƒ½
      } else {
        alert("çµŒè·¯æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ: " + status);
      }
    });
  }
</script>